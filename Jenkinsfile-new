pipeline {
    agent any

    environment {
        SCANNER_HOME = tool 'sonarqube'  // SonarScanner tool name
        SONAR_TOKEN = credentials('sonarqube-new-login-token')
    }
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/UnstopableSafar08/jenkins-demo.git'
            }
        }

        stage('SonarQube Scan') {
            steps {
                withSonarQubeEnv('sonarqube') {
                    sh """
                        ${SCANNER_HOME}/bin/sonar-scanner \
                        -Dsonar.projectName=staticSite \
                        -Dsonar.projectKey=staticSite \
                        -Dsonar.token=${SONAR_TOKEN}
                    """
                }
            }
        }

        stage('Sonar Quality Gate') {
            steps {
                timeout(time: 2, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: false
                }
            }
        }

        stage('OWASP Dependency-Check') {
            steps {
                dependencyCheck additionalArguments: '--scan . --format HTML --out .', odcInstallation: 'dc'
                dependencyCheckPublisher pattern: 'dependency-check-report.html'
            }
        }

        stage('Build Docker Image') {
            steps {
                sh 'docker build -t static-site .'
            }
        }

        stage('Trivy Image Scan') {
            steps {
                sh '''
                    trivy image \
                        --severity CRITICAL,HIGH \
                        --cache-dir /var/lib/trivy \
                        static-site
                '''
            }
            post {
                failure {
                    echo "Trivy Image Scan found vulnerabilities!"
                }
            }
        }

        stage('Trivy FileSystem Scan') {
            steps {
                sh '''
                    # Generate table report
                    trivy fs --format table --output trivy-fs-report.txt .

                    # Generate HTML report using template
                    trivy fs --format template \
                        --template "/opt/html.tpl" \
                        --output trivy-fs-report.html .
                '''
            }
            post {
                always {
                    archiveArtifacts artifacts: 'trivy-fs-report.*'
                }
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                docker rm -f static-site || true
                docker run -d --name static-site -p 8081:80 static-site
                '''
            }
        }
    }
}
